name: Deploy to K3d

on:
  workflow_run:
    workflows: ["Build and Push"]
    types: [completed]

jobs:
  deploy:
    runs-on: self-hosted  # 运行在你自己的服务器上
    # 只有 Build 成功了才执行部署
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # 1. 从刚才成功的 Build 工作流中下载 Artifact
      - name: Download Tag Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-context
          run-id: ${{ github.event.workflow_run.id }} # 指定来源 ID
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 从文件中读取 Tag 到环境变量
      - name: Load Tag to Env
        run: |
          TAG_VALUE=$(cat build_tag.txt)
          echo "DEPLOY_TAG=$TAG_VALUE" >> $GITHUB_ENV
          echo "检测到待部署的镜像标签为: $TAG_VALUE"

      # 3. 部署到 k3d 集群
      - name: Kubernetes Rolling Update
        run: |
          # 登录以便拉取镜像 (如果是私有镜像)
          docker login ghcr.io -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
          
          # 更新 K8s Deployment 的镜像
          # 这里的 my-api 和 api-container 请替换为你实际的值
          kubectl set image deployment/my-api api-container=ghcr.io/${{ github.repository }}/api:${{ env.DEPLOY_TAG }}
          
          # 等待滚动更新完成，确保部署成功
          kubectl rollout status deployment/my-api --timeout=60s

      # 4. 可选：清理本次任务的临时文件
      - name: Post Cleanup
        if: always()
        run: rm -f build_tag.txt