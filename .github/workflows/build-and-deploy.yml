name: CI/CD Pipeline

on:
  pull_request_target:
    types: [labeled, synchronize] # åªæœ‰æ‰“æ ‡ç­¾æˆ– PR æ›´æ–°æ—¶è§¦å‘

jobs:
  # 1. åœ¨ GitHub å…è´¹èµ„æºä¸Šæ„å»ºå¹¶æ¨é€
  build-and-push:
    # ä»…å½“ PR å¸¦æœ‰ 'ok-to-test' æ ‡ç­¾ï¼Œæˆ–è€…æ˜¯ç»„ç»‡å†…éƒ¨æˆå‘˜æäº¤æ—¶è¿è¡Œ
    if: |
      contains(github.event.pull_request.labels.*.name, 'ok-to-test') ||
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'OWNER'
    runs-on: ubuntu-latest  # ä½¿ç”¨ GitHub å…è´¹ç®—åŠ›
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and Push Images
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          # é•œåƒæ‰“ä¸Š pr-xxx çš„æ ‡ç­¾
          make docker-all REGISTRY=ghcr.io/${OWNER_LOWER} TAG=pr-${{ github.event.pull_request.number }}

  # 2. åœ¨ä½ çš„ Self-hosted æœåŠ¡å™¨ä¸Šéƒ¨ç½²
  deploy:
    needs: build-and-push
    runs-on: self-hosted    # åˆ‡æ¢åˆ°ä½ è‡ªå·±çš„æœåŠ¡å™¨
    steps:
      # ç¬¬ä¸€æ­¥ï¼šç›´æ¥æ‹‰å–å½“å‰ PR çš„æœ€æ–°ä»£ç 
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Deploy to K3s/K8s
        run: |
          export PATH=$PATH:/usr/local/go/bin:$(go env GOPATH)/bin
          
          echo "Current PATH: $PATH"
          go version # æ‰“å°ä¸€ä¸‹ç¡®è®¤
          
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          PR_TAG="pr-${{ github.event.pull_request.number }}"
          NAMESPACE="wireflow-pr-${{ github.event.pull_request.number }}"
          
          echo "ğŸš€ Deploying pr-${{ github.event.pull_request.number }}"
          
          # è¿™é‡Œçš„ make deploy éœ€è¦æ”¯æŒä¼ å…¥ REGISTRY, TAG å’Œ NAMESPACE
          make deploy IMG=ghcr.io/wireflowio/manager:$PR_TAG

      # åœ¨ GitHub Action çš„æ­¥éª¤é‡ŒåŠ å…¥åˆ¤æ–­
      - name: Run E2E Tests
        if: contains(github.event.pull_request.labels.*.name, 'run-e2e')
        run: make test-e2e
